# Gnosis Validator Withdraw Time Checker

A Python tool to calculate the exact withdrawable epoch and time for Gnosis Chain validators. This tool queries a Gnosis Beacon Chain node to retrieve validator information and calculates when exited validators will become withdrawable.

## Features

- ✅ **Dynamic Chain Configuration**: Automatically detects network parameters (Gnosis, Ethereum, etc.)
- ✅ **Batch Processing**: Process multiple validators from YAML files
- ✅ **CSV Export**: Export results with withdrawable epochs, timestamps, and effective balances
- ✅ **Effective Balance Tracking**: Shows validator balances in GNO
- ✅ **Smart Filtering**: Skip validators not present in your index map
- ✅ **Rate Limiting**: Configurable sleep intervals between API requests

## Requirements

- Python 3.7+
- `requests` library
- `PyYAML` library

## Installation

1. Clone this repository:
```bash
git clone https://github.com/zheli/gnosis-validator-withdraw-time-checker.git
cd gnosis-validator-withdraw-time-checker
```

2. Install dependencies:
```bash
pip install requests PyYAML
```

## Usage

### Single Validator Check

Query a single validator by index or public key:

```bash
python3 check_withdrawal_time.py <VALIDATOR_INDEX_OR_PUBKEY> --node https://your-gnosis-beacon-node.com
```

**Example:**
```bash
python3 check_withdrawal_time.py 12345 --node https://rpc.gnosischain.com/beacon
```

### Batch Processing

Process multiple validators from YAML using the `offline-preparation.json` file generated by `ethdo` 

```bash
python3 check_withdrawal_time.py --yaml operators.yaml --json offline-preparation.json --out results.csv --node https://your-gnosis-beacon-node.com
```

**Example:**
```bash
python3 check_withdrawal_time.py --yaml operators.yaml --json offline-preparation.json --out withdrawal_times.csv --node https://rpc.gnosischain.com/beacon --sleep 0.1
```

## Input File Formats

### YAML File (`operators.yaml`)

Contains validator public keys organized by operator:

```yaml
operators:
  - name: my-batch-1
    keys:
      - "validator pubkey 1"
      - "validator pubkey 2"

  - name: my-batch-2
    keys:
      - "validator pubkey 3"
      - "validator pubkey 4"
```

### offline-preparation.json (JSON File for validator indeces)
Download it using ethdo

```
ethdo validator exit --prepare-offline --connection https://my-beacon-node
```

It looks like this:
```json
{
  "version": "3",
  "validators": [
    {
      "index": "0",
      "pubkey": "0x970225d14cb7755ffa901c58b8954ac4d74903feea95e69f7b618ff0122b109402dbebc09c552ba7ccea2bb693f61c95",
      "state": "withdrawal_done",
      "withdrawal_credentials": "0x01000000000000000000000060c0a957542b6236b292d6d53a1d7ec0a9c746e9"
    },
    {
      "index": "1",
      "pubkey": "0xa64acd64e7d274fb22f7125d0ff7bb790fbf8895fdfb46d127ff95553b49f7cbcfd70ec9f9cf8609c6522918bfd237bd",
      "state": "withdrawal_done",
      "withdrawal_credentials": "0x01000000000000000000000060c0a957542b6236b292d6d53a1d7ec0a9c746e9"
    }
  ]
}
```

## Output Format

The tool generates a CSV file with the following columns:

| Column | Description |
|--------|-------------|
| `pubkey` | Validator public key |
| `withdrawable_epoch` | Epoch when validator becomes withdrawable |
| `withdrawable_time_iso` | ISO 8601 timestamp of withdrawable time |
| `time_remaining` | Time remaining until withdrawable (if applicable) |
| `effective_balance_gno` | Validator effective balance in GNO |
| `status` | Current validator status |
| `note` | Additional information or errors |

**Example Output:**
```csv
pubkey,withdrawable_epoch,withdrawable_time_iso,time_remaining,effective_balance_gno,status,note
0xa159c992...,123456,2025-12-15T10:30:00+00:00,5 days 3:15:22,1.0,active_exiting,
0x8efeb435...,123450,2025-12-14T08:00:00+00:00,0:00:00,1.0,withdrawal_possible,Eligible for sweep
```

## Command-Line Options

| Option | Description | Default |
|--------|-------------|---------|
| `validator_id` | Single validator index or public key | - |
| `--yaml` | Path to YAML file with operator keys | - |
| `--json` | Path to JSON file with validator indices | - |
| `--out` | Output CSV file path | `withdrawal_times.csv` |
| `--node` | Beacon Node URL | `http://localhost:5052` |
| `--sleep` | Sleep duration between requests (seconds) | `0.0` |

## How It Works

1. **Fetch Chain Configuration**: Retrieves `SECONDS_PER_SLOT` and `SLOTS_PER_EPOCH` from the beacon node
2. **Get Genesis Time**: Fetches the network genesis timestamp
3. **Query Validators**: Retrieves validator data including exit and withdrawable epochs
4. **Calculate Timestamps**: Uses the formula:
   ```
   Withdrawable Time = Genesis Time + (Withdrawable Epoch × Slots Per Epoch × Seconds Per Slot)
   ```
5. **Convert Balances**: Converts effective balance from Gwei to GNO (32,000,000,000 Gwei = 1 GNO)

## Gnosis Chain Specifics

Gnosis Chain has different parameters compared to Ethereum:
- **Seconds per Slot**: 5 seconds (vs 12 on Ethereum)
- **Slots per Epoch**: 16 slots (vs 32 on Ethereum)

The tool automatically detects these parameters from the beacon node, ensuring accurate calculations.

## Beacon Node Options

You can run your own beacon node using Lighthouse, Prysm or Teku.

## Troubleshooting

### "Error fetching chain config"
- Verify your beacon node URL is correct and accessible
- Check that the node's API is enabled

### "Validator not found on chain"
- Ensure the validator index/pubkey is correct
- The validator may not be deposited yet

### "Skipped X keys not found in JSON map"
- This is normal if your YAML contains keys not in the JSON file
- Only validators present in the JSON file will be processed

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Acknowledgments

- Built for the Gnosis Chain validator community
- Compatible with any Ethereum Beacon Chain network

## Support

For issues or questions, please open an issue on GitHub.
